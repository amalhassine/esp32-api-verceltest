from machine import Pin, ADC, PWM
import onewire, ds18x20
import time
import urequests
import network
from lcd_api import LcdApi
from i2c_lcd import I2cLcd

# --- Connexion Wi-Fi
sta_if = network.WLAN(network.STA_IF)
sta_if.active(True)
sta_if.connect("itel A56")  # Remplacer par votre SSID
print("Connexion au Wi-Fi...")
while not sta_if.isconnected():
    time.sleep(1)
print("‚úÖ Connect√© ! IP :", sta_if.ifconfig()[0])

# --- Capteurs
ds_pin = Pin(4)
ow = onewire.OneWire(ds_pin)
ds = ds18x20.DS18X20(ow)
roms = ds.scan()

pin_yl69 = ADC(Pin(35))
pin_yl69.atten(ADC.ATTN_11DB)

# --- Sorties
led_verte1 = Pin(32, Pin.OUT)
led_verte2 = Pin(33, Pin.OUT)
led_rouge1 = Pin(25, Pin.OUT)
led_rouge2 = Pin(26, Pin.OUT)
buzzer = PWM(Pin(27))
relais = Pin(23, Pin.OUT)

# --- LCD
i2c = I2C(0, scl=Pin(22), sda=Pin(21))
lcd = I2cLcd(i2c, 0x27, 2, 16)

# --- Fonctions
def get_temperature():
    if not roms:
        return -999
    ds.convert_temp()
    time.sleep_ms(750)
    return round(ds.read_temp(roms[0]), 1)

def get_humidite():
    value = pin_yl69.read()
    pourcentage = (value * 100) / 4095
    return round(pourcentage, 1)

def activer_buzzer():
    buzzer.freq(1000)
    buzzer.duty(512)

def couper_buzzer():
    buzzer.duty(0)

# --- Boucle principale
while True:
    temp = get_temperature()
    hum = get_humidite()

    lcd.clear()
    lcd.putstr("Smart Farming")
    lcd.move_to(0, 1)
    lcd.putstr("H:{:.1f}% T:{:.1f}C".format(hum, temp))

    try:
        r = urequests.get("https://esp32-api-verceltest.vercel.app/api/commandes", timeout=10)
        if r.status_code == 200:
            commandes = r.json()
            r.close()

            if commandes.get("pompe") == "ON":
                relais.on()
                print("üöø Pompe activ√©e √† distance")
            else:
                relais.off()
                print("üõë Pompe d√©sactiv√©e")

            if commandes.get("buzzer") == "ON":
                activer_buzzer()
                print("üîî Buzzer activ√© √† distance")
            else:
                couper_buzzer()
                print("üîï Buzzer d√©sactiv√©")
        else:
            print(f"‚ùå Erreur HTTP : {r.status_code}")

    except OSError as e:
        print(f"‚ùå Erreur de connexion : {e}")

    time.sleep(10)  # pause de 10 secondes avant la prochaine lecture
